name: Deploy SIA to VPS

on:
  push:
    branches: [ main ]   # cambia si despliegas desde otra rama

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # PHP para Composer (solo si hay composer.json)
      - name: Setup PHP
        if: ${{ hashFiles('composer.json') != '' }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, intl, pdo_mysql, curl, gd, zip
          tools: composer

      - name: Install PHP dependencies (Composer)
        if: ${{ hashFiles('composer.json') != '' }}
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      # Node para build de assets (solo si hay package.json)
      - name: Setup Node
        if: ${{ hashFiles('package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build assets
        if: ${{ hashFiles('package.json') != '' }}
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          if npm run | grep -q "build"; then npm run build; fi


      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SIA_SSH_KEY }}" > ~/.ssh/gha_sia
          chmod 600 ~/.ssh/gha_sia
          ssh-keyscan -p 3500 174.136.26.185 >> ~/.ssh/known_hosts

      - name: Test SSH connectivity (verbose)
        run: |
          ssh -vvv -i ~/.ssh/gha_sia -p 3500 \
            -o BatchMode=yes -o StrictHostKeyChecking=no \
            calientes@174.136.26.185 'echo ok-ssh'

      - name: Rsync to server
        run: |
          RSYNC_FLAGS="-az --delete \
            --exclude .git --exclude .github \
            --exclude node_modules --exclude '*.log'"
          DEST="calientes@174.136.26.185:/home/calientes/domains/serviciosinmobiliariosaguascalientes.com/public_html/"
          rsync $RSYNC_FLAGS -e "ssh -i ~/.ssh/gha_sia -p 3500" ./ "$DEST"